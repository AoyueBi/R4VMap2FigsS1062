---
title: "Data analysis"
author: "Aoyue Bi, Daxing Xu"
date: "`r Sys.Date()`"
output: 
  html_document: # html_notebook, html_document
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: simplex # default, united, cerulean, journal, flatly, darkly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, and yeti
    highlight: haddock # default, tango, pygments, kate, monochrome, espresso, zenburn, haddock, and breezedark
    # bibliography: bibliography.json
---


# Fig2

```{r setup, echo =F, message = T, warning = F}
library(tidyverse)
# library(RColorBrewer)
library(ggpubr)
# library(egg)
## eval 代码要不要运行
## echo 代码要不要输出
## include 图要不要输出
## warning 警告要不要输出
## message 默认Bin等信息要不要输出
```

## SNP count only derived allele by Sub

import data
```{r}
dftotal <- read_tsv("data/005_SNPAnnoDB/geneSNPAnno.txt.gz") %>%
  mutate(Sub=str_sub(Transcript, 9, 9))
```


```{r}
### 区分亚基因组
df <- dftotal %>% 
  mutate(Sub=str_sub(Transcript, 9, 9)) %>% 
  filter(!is.na(Ancestral)) %>%
  filter(Ancestral==Ref|Ancestral==Alt) %>%
  # filter(!is.na(DAF)) %>% 
  mutate(LoadGroup=ifelse(Variant_type %in% c("NONSYNONYMOUS") & Gerp_16way >=2.14,"Deleterious", ifelse(Variant_type=="SYNONYMOUS", "Synonymous", ifelse(Variant_type=="NONSYNONYMOUS", "Nonsynonymous", NA)))) %>% 
  filter(!is.na(LoadGroup)) %>% 
  group_by(Sub) %>% 
  count(LoadGroup) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup))

### 不区分亚基因组
df <- dftotal %>% 
  mutate(Sub=str_sub(Transcript, 9, 9)) %>% 
  filter(!is.na(Ancestral)) %>%
  filter(Ancestral==Ref|Ancestral==Alt) %>%
  # filter(!is.na(DAF)) %>% 
  mutate(LoadGroup=ifelse(Variant_type %in% c("NONSYNONYMOUS") & Gerp_16way >=2.14,"Deleterious", ifelse(Variant_type=="SYNONYMOUS", "Synonymous", ifelse(Variant_type=="NONSYNONYMOUS", "Nonsynonymous", NA)))) %>% 
  filter(!is.na(LoadGroup)) %>% 
  # group_by(Sub) %>%
  count(LoadGroup) %>% 
  mutate(fre=n/sum(n)) 

### 只画柱状图 dodge
# colB <- c("#d5311c","#004680","#e69f00")
# p <- df %>% 
# ggplot(aes(x=Sub,y=n,fill=LoadGroup))+
#   geom_bar(stat = 'identity',position = "dodge")+
#   geom_text(aes(label=paste(n,"\n(",round(fre,2),")",sep = "")),size=3,
#             position = position_dodge(0.9))+
#   # geom_text(aes(label=paste(n,"\n(",round(fre,2),")",sep = "")),size=3,nudge_y = 1)+
#   labs(x="", y="SNP count")+
#   scale_fill_brewer(palette = "Set2")+
#   scale_fill_manual(values = colB)+
#   # scale_fill_brewer(palette = "Blues")+
#   theme_classic()+
#   # theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
#   theme(legend.position = "none",plot.margin=unit(rep(1,4),'lines'),
#           axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))
# 
# p

### 只画柱状图 stack

colB <- c("#d5311c","#e69f00","#004680")
df$LoadGroup <- factor(df$LoadGroup,levels = c("Deleterious","Nonsynonymous","Synonymous"))
p <- df %>% 
  ggplot(aes(x=Sub, y=n,fill=LoadGroup)) +
  geom_bar(stat="identity",alpha = 1)+  #,position=position_dodge()
  geom_text(aes(label=  paste(prettyNum(n,big.mark = ","),"(",round(fre,2),")")),position =  position_stack(),vjust=1.5, size=3) +
  scale_fill_manual(values=colB)+
  # ylab("SNP count (kb)") +
  labs(y="SNP count",x="")+
  theme(panel.background = element_rect(size = 0.7, colour = 'black',fill = 'white'),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size = 12)
        ,legend.position = 'none'
        )

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```

### Total count by LoadGroup
- 只计算有祖先状态的位点
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  # select(Variant_type,Derived_SIFT,Gerp,LoadGroup)
  # group_by(Sub) %>% 
  count(LoadGroup) %>% 
  mutate(fre=n/sum(n))

### 只画柱状图 dodge
colB <- c("#d5311c","#e69f00","#004680")

p <- df %>%
ggplot(aes(x=LoadGroup,y=n,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  geom_text(aes(label=paste(n,"\n(",round(fre,2),")",sep = "")),size=3,
            position = position_dodge(0.9))+
  # geom_text(aes(label=paste(n,"\n(",round(fre,2),")",sep = "")),size=3,nudge_y = 1)+
  labs(x="", y="SNP count")+
  scale_fill_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(legend.position = "none",plot.margin=unit(rep(1,4),'lines'),
          axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))

p

### 求某一列的和
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

sum(df$n)
```
## 只取有害突变的位点，
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(LoadGroup == "Deleterious") 

# write.table(df,file="/Users/Aoyue/Documents/DeleteriousSite_VMap2.txt",quote=F,col.name=T,row.names=F,sep = "\t") 

df <- df %>% 
  group_by(Transcript) %>% 
  count(Transcript)

mean(df$n)
median(df$n)

df <- df %>% filter(n==1)
```
- 统计有害突变在几个基因中
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(LoadGroup == "Deleterious") %>%
  group_by(Transcript) %>% 
  count(Transcript)
```

```{r}
# df <- dftotal %>% filter(Region=="CDS",Variant_type=="NONSYNONYMOUS")
# nrow(df)

### 有害突变
# df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
#   mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
#   mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
#   mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
#   filter(LoadGroup == "Deleterious")
# 
# nrow(df)

### GERP 有害个数
df <- dftotal %>% filter(Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  # mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  # filter(Gerp >= 1)
  filter(Derived_SIFT < 0.05)

nrow(df)

```



## ========================
## GERP distribution by DAF
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  filter(!is.na(Gerp)) %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  # mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05 & Gerp >=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%  #&Gerp>=1
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(Gerp > 0) %>%
  mutate(bin=cut_interval(Gerp,n=10)) %>% 
  group_by(bin) %>% 
  count(LoadGroup) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(desc(bin)) 

#### facet by sub
colB <- c("#d5311c","#e69f00","#004680")
p <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,color=LoadGroup))+
  geom_line(aes(linetype=LoadGroup),size=1)+
  # scale_linetype_manual(values=c("dotdash","dotdash","dotdash"))+
  # scale_linetype_manual(values=c("dotdash","dotdash","dotdash"))+
  labs(y="Fraction in each category",x="GERP score")+
  geom_vline(xintercept = 3,linetype="dashed",color="blue")+
  scale_color_manual(values = colB)+
  scale_y_continuous(limits = c(0,1))+
  scale_x_discrete(labels = c("0","0.35","0.7","1.05","1.4","1.75","2.1","2.45","2.8","3.15"))+
  # coord_cartesian(xlim = c(14,20))+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines')
        ,legend.position = "none"
        ,axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))
        
p
# ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)


```
### GERP 比例, nonsynonymous比例，deleterious比例
```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  filter(!is.na(Gerp),Gerp>0) 
nrow(df) #369935
 
```


##========================
## Sample size to variants discovery
### 1.Plot contains UTR loop
## ！！！！！！！！AB sub:ori line-stat-max point
- Conclusion: 抽样必须是样品递增的，不能每次随机抽取
## ------------------
### count
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/1.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```

### sacle count
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/1_scale.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```

### sacle_y_x count 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```

## ------------------
### 百分比
- 导入数据-过滤数据-写函数-建立新数据框-合并数据框-设置因子和自定义颜色-画图
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      # legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```

### scale 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar",
               # width = 8,
               width = 0.1,
               fun.min = min,
               fun.max = max,
               aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```

### scale_y_x 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar",
               # width = 8,
               width = 0.1,
               fun.min = min,
               fun.max = max,
               aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```
## ------------------
### Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```

### scale Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale_y_x Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```
## ------------------
### Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_log10(limits = c(10,1000))+
  # scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale_y_x Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```


##-----------------------------------------------
## ！！！！！！！！！D sub:ori line-stat-max point
- Conclusion: 抽样必须是样品递增的，不能每次随机抽取
## ------------------
### count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/2.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```

### scale count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
    scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/2_scale.pdf",height = 3,width = 4)


```
### scale_y_x count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")
p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/2_scale_xy.pdf",height = 3,width = 4)

```

## ------------------
### 百分比
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```
### scale 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```
### scale_y_x 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```
## ------------------
### Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale_y_x Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```

## ------------------
### Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

### scale_y_x Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

df <- df %>% filter(Group != "NA") %>% 
  filter(Group == "Nonsyn"|Group == "Syn"|Group == "UTR") %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))
colB <- c("DarkGrey", "#004680","Orange")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```






## =======================
### 2.Plot contains deleterious loop
## AB sub:ori line-stat-max point
- Conclusion: 抽样必须是样品递增的，不能每次随机抽取

## ------------------
### count
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")
p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/3.pdf",height = 3,width = 4)

```

### sacle count
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/3_scale.pdf",height = 3,width = 4)

```

### sacle_y_x count 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()


df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- df %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/3_scale_xy.pdf",height = 3,width = 4)

```

## ------------------
### 百分比
- 导入数据-过滤数据-写函数-建立新数据框-合并数据框-设置因子和自定义颜色-画图
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      # legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```

### scale 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")
p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar",
               # width = 8,
               width = 0.1,
               fun.min = min,
               fun.max = max,
               aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```

### scale_y_x 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar",
               # width = 8,
               width = 0.1,
               fun.min = min,
               fun.max = max,
               aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)
```

## ------------------
### Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  


## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


  
dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement_percent.pdf",height = 3,width = 4)

```

### scale Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")


p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement_percent_scale.pdf",height = 3,width = 4)
```

### scale_y_x Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement_percent_scale_xy.pdf",height = 3,width = 4)
```
## ------------------
### Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  # scale_x_log10(limits = c(10,1000))+
  # scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement.pdf",height = 3,width = 4)
```

### scale Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement_scale.pdf",height = 3,width = 4)
```

### scale_y_x Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 607)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)

dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="New sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/3_increasement_scale_xy.pdf",height = 3,width = 4)
```




## ！！！！！！！！！D sub:ori line-stat-max point
- Conclusion: 抽样必须是样品递增的，不能每次随机抽取
## ------------------
### count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/4.pdf",height = 3,width = 4)

```

### scale count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
    scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/4_scale.pdf",height = 3,width = 4)


```
### scale_y_x count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/4_scale_xy.pdf",height = 3,width = 4)

```

## ------------------
### 百分比
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_cdf.pdf",height = 3,width = 4)

```
### scale 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")

p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_cdf_scale.pdf",height = 3,width = 4)
```
### scale_y_x 百分比
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  
  
df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

### 找到每种分类下
aoFindMaxLine <- function(dfinput){
  maxtaxanum = max(dfinput$TaxaNum)
  dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
  return(dfout)
}

### 发现每个分类的最大值
dfpoint <- df %>% group_by(Group) %>% 
  group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))


### 将每个分类的最大值合并入文件中
dfpoint <- dfpoint %>% select(Group,TotalNum = ObservedCount) %>% distinct(.,Group,.keep_all = T) ### 删除重复的行
df <- df %>% left_join(.,dfpoint,by = "Group")


p <- df %>% 
  mutate(CDF = ObservedCount/TotalNum) %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=CDF))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="CDF")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(1,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = 'none',
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_cdf_scale_xy.pdf",height = 3,width = 4)
```
## ------------------
### Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()
  


## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement_percent.pdf",height = 3,width = 4)
```

### scale Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


  
dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement_percent_scale.pdf",height = 3,width = 4)
```

### scale_y_x Increasement percent
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement_percent_scale_xy.pdf",height = 3,width = 4)

```

## ------------------
### Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)
  
dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               # ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_continuous(breaks = seq(0,600,200),labels = c(1,200,400,600))+
  # scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement.pdf",height = 3,width = 4)
```

### scale Increasement 
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)


dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  # scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement_scale.pdf",height = 3,width = 4)
```

### scale_y_x Increasement
```{r}
df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

## 建立2个数据框，第一个是去除taxaNum为1的数据框 df_taxaNumNo1 ;第二个是去除taxaNum为最大值的数据框 df_taxaNumNomax

df_taxaNumNo1 <- df %>% 
  filter(TaxaNum != 1)

df_taxaNumNomax <- df %>% 
  filter(TaxaNum != 456)

df_taxaNumNo1$Increasement <- df_taxaNumNo1$ObservedCount - df_taxaNumNomax$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 456,Loop==1) %>% select(Group, ObservedCount)

dfnew <- df_taxaNumNo1 %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)

dfnew$Group <- factor(dfnew$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- dfnew %>% 
  filter(TaxaNum < 456) %>% 
  ggplot(aes(x=TaxaNum,y=Increasement))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Percent of new sites observed\nto be variable per additional sample")+
  scale_color_manual(values = colB)+
  scale_x_log10(limits = c(10,1000))+
  scale_y_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      legend.position = "none",
      text = element_text(size = 12))

p
ggsave(p,filename = "~/Documents/4_increasement_scale_xy.pdf",height = 3,width = 4)
```

### 最原始的结果
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/Dsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>% 
  filter(Group %in% factor1) %>%
  droplevels()

df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")
p <- df %>% 
  filter(TaxaNum < 451) %>% 
  ggplot(aes(x=TaxaNum,y=ObservedCount/1000))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               ,width = 8
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable per kb")+
  scale_color_manual(values = colB)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),legend.position = 'none')

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```




##========================
## DAF
import data
```{r}
dataFile <- c("data/001_exonSNP_anno.txt.gz")
dftotal <- read.delim(dataFile)

dataFile <- c("/Users/Aoyue/Documents/Data/wheat/chrConvertionRule.txt")
dfchrmap <- read.delim(dataFile)
dfchrmap <- dfchrmap %>% filter(!ChrID == "0", !ChrID=="43",!ChrID=="44") %>%
  mutate(OriChrName=str_sub(OriChrName,4,5),Sub=str_sub(OriChrName,2,2)) %>%
  select(ChrID,OriChrName,Sub) %>%
  select(Chr=ChrID,Sub)

dftotal <- dftotal %>% left_join(.,dfchrmap,by="Chr")
```

### AABBDD: keep all sites
只要是AABBDD有分离即可
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_ABD)) %>% 
  mutate(bin=cut_width(DAF_ABD,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) 
  ### merge group
  # mutate(group = paste(IfRefisAnc,"-",str_sub(LoadGroup,1,3),sep = ""))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
df$Sub <- factor(df$Sub, levels = c("A","B","D"), labels = c("A subgenome","B subgenome","D subgenome"))
q <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  scale_y_continuous(limits = c(0,0.85),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  facet_grid(Sub~.)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.3, colour = "black")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
q

ggsave(q,filename = "~/Documents/test.pdf",height = 4,width = 4)

```

### AABBDD: keep all sites in segregation
AABBDD AABB DD 三个群体都必须有分离

```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_ABD),!is.na(DAF_AB)) %>%  ###*****
  mutate(bin=cut_width(DAF_ABD,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) 
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,1))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(Sub~.)+
  theme_classic()+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))

q

ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )


```

### AABB: keep all sites 

只要是AABB有分离即可
```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_AB)) %>% 
  mutate(bin=cut_width(DAF_AB,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) 
  ### merge group
  # mutate(group = paste(IfRefisAnc,"-",str_sub(LoadGroup,1,3),sep = ""))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
df$Sub <- factor(df$Sub, levels = c("A","B","D"), labels = c("A subgenome","B subgenome","D subgenome"))
q <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  scale_y_continuous(limits = c(0,0.85),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  facet_grid(Sub~.)+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.3, colour = "black")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
q

ggsave(q,filename = "~/Documents/test.pdf",height = 4,width = 4)

```

### AABB: keep all sites in segregation
AABBDD AABB DD 三个群体都必须有分离

```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_AB), !is.na(DAF_ABD)) %>% 
  mutate(bin=cut_width(DAF_AB,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) 
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,1))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(Sub~.)+
  theme_classic()+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))

q

ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )


```



### 6 4 2 together line chart
```{r}
### hexaploid
dfabd <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_AB), !is.na(DAF_ABD)) %>% 
  mutate(bin=cut_width(DAF_ABD,width = 0.05,boundary = 0)) %>% 
  ### A sub B sub merging
  mutate(Subs = ifelse(Sub=="D","D","AB")) %>%
  group_by(Subs,LoadGroup) %>%
  count(bin) %>%
  mutate(fre=n/sum(n)) %>%
  arrange(Subs,desc(LoadGroup)) %>%
  mutate(GenomeType = "AABBDD") %>%
  mutate(MergeGroup=paste(GenomeType,"-",Subs,sep = ""))

### A sub B sub D sub merging
  # mutate(Subs = ifelse(Sub=="D","AB","AB")) %>% 
  # group_by(Subs,LoadGroup) %>% 
  # count(bin) %>% 
  # mutate(fre=n/sum(n)) %>% 
  # arrange(Subs,desc(LoadGroup)) %>% 
  # mutate(GenomeType = "AABBDD") %>% 
  # mutate(MergeGroup=paste(GenomeType,"-",Subs,sep = ""))
  

dfab <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_AB), !is.na(DAF_ABD),Sub=="A"|Sub=="B") %>% 
  mutate(bin=cut_width(DAF_AB,width = 0.05,boundary = 0)) %>% 
  ### A sub B sub merging
  mutate(Subs = ifelse(Sub=="A"|Sub=="B","AB","D")) %>% 
  group_by(Subs,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Subs,desc(LoadGroup)) %>% 
  mutate(GenomeType = "AABB") %>% 
  mutate(MergeGroup=paste(GenomeType,"-",Subs,sep = ""))


dfd <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF_AB), !is.na(DAF_ABD),Sub=="D") %>% 
  mutate(bin=cut_width(DAF_AB,width = 0.05,boundary = 0)) %>% 
  ### A sub B sub merging
  mutate(Subs = ifelse(Sub=="D","D","AB")) %>% 
  group_by(Subs,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Subs,desc(LoadGroup)) %>% 
  mutate(GenomeType = "DD") %>% 
  mutate(MergeGroup=paste(GenomeType,"-",Subs,sep = ""))

df <- rbind(dfabd,dfab,dfd)

colB <- c("#ffd702","red","blue","#87cef9")
p <- df %>% 
  filter(LoadGroup=="Deleterious") %>% 
  ggplot(aes(x=bin,y= fre,group=MergeGroup,color=MergeGroup))+
  geom_line(aes(linetype=MergeGroup))+
  scale_linetype_manual(values=c("solid","dotdash","dashed","dotdash"))+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_color_manual(values = colB)+
  scale_y_continuous(limits = c(0,0.72))+
  scale_x_discrete(labels=c(0,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,1))+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12))+
  theme(axis.text.x = element_text(size = 10),legend.position = 'none')
#,legend.position = 'none'

p
 
ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 5 )


# #### facet by sub
# colB <- rep(c("#d5311c","#e69f00","#004680"),2)
# q <- df %>% 
#   ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
#   geom_bar(stat = 'identity',position = "dodge")+
#   labs(y="Proportion",x="Derived allele frequency")+
#   # scale_color_brewer(palette = "Set2")+
#   scale_fill_manual(values = colB)+
#   scale_y_continuous(limits = c(0,1))+
#   # scale_fill_brewer(palette = "Blues")+
#   facet_grid(Sub~.)+
#   theme_classic()+
#   theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
#   theme(plot.margin=unit(rep(1,4),'lines'),
#         legend.title = element_blank(),
#         axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))
# 
# q
# 
# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )


```

### !only daf

```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) 
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  ggplot(aes(x=bin,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,1))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(Sub~.)+
  theme_classic()+
  theme(axis.text.x= element_text(angle=90, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))

q

# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )
ggsave(q,filename = "~/Documents/test.pdf",height = 3.6,width = 3.6 )


```





### !only daf 坐标轴改变，最终确定

```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  ggplot(aes(x=as.character(binStart) ,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,0.88),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(Sub~.)+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=90, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))+
    theme(strip.text = element_blank())


q

# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )
ggsave(q,filename = "~/Documents/test.pdf",height = 4,width = 3)


```

### !only daf 坐标轴改变,AB 合并在一起

```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  mutate(mergedSub = if_else(Sub == "D","D","AB")) %>% 
  group_by(mergedSub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(mergedSub,desc(LoadGroup)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  ggplot(aes(x=as.character(binStart) ,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,0.88),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(mergedSub~.)+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=90, vjust=1,hjust = 1))+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))+
    theme(strip.text = element_blank())


q

# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )
ggsave(q,filename = "~/Documents/test.pdf",height = 4,width = 3)


```

### DAF stop-gain
```{r}
unique(dftotal$Variant_type) 
```


```{r}

df2 <- dftotal %>% 
  filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")

df1 <- dftotal %>% 
  mutate(Variant_type=as.character(Variant_type)) %>% 
  filter(Variant_type!="NONCODING") %>% 
  mutate(LoadGroup = ifelse(Variant_type %in% c("SYNONYMOUS","NONSYNONYMOUS"),Variant_type,"Del" )) %>% 
  # filter(!Ancestral == "NA") %>% 
  # filter(Ancestral==Ref|Ancestral==Alt) %>% 
  # mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  mutate(mergedSub = if_else(Sub == "D","D","AB")) %>% 
  group_by(mergedSub,Variant_type) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(mergedSub,desc(Variant_type)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df1 %>% 
  mutate(Variant_type=factor(Variant_type, levels = c("STOP-GAIN","START-LOST","NONSYNONYMOUS","STOP-LOSS","SYNONYMOUS"))) %>% 
  # filter(mergedSub == "D") %>% 
  ggplot(aes(x=as.character(binStart) ,y=fre,group=Variant_type,fill=Variant_type))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_brewer(palette = "Set2")+
  # scale_fill_manual(values = colB)+
  # scale_y_continuous(limits = c(0,0.88),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  # scale_fill_brewer(palette = "Blues")+
  facet_grid(mergedSub~.)+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=90, vjust=1,hjust = 1))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),
        # legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))


q

# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )
ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 4)

temp <- df1 %>% 
  mutate(Variant_type=factor(Variant_type, levels = c("STOP-GAIN","START-LOST","NONSYNONYMOUS","STOP-LOSS","SYNONYMOUS"))) %>%
  group_by(Variant_type,mergedSub) %>% 
  count()

```


```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  mutate(mergedSub = if_else(Sub == "D","D","AB")) %>% 
  group_by(mergedSub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(mergedSub,desc(LoadGroup)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2))
 
#### facet by sub
colB <- rep(c("#d5311c","#e69f00","#004680"),2)
q <- df %>% 
  filter(mergedSub == "D") %>% 
  ggplot(aes(x=as.character(binStart) ,y=fre,group=LoadGroup,fill=LoadGroup))+
  geom_bar(stat = 'identity',position = "dodge")+
  labs(y="Proportion",x="Derived allele frequency")+
  # scale_color_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  scale_y_continuous(limits = c(0,0.88),breaks = seq(0,0.8,0.2))+
  scale_x_discrete(labels=c("0","","","","0.2","","","","0.4","","","","0.6","","","","0.8","","","",""))+
  # scale_fill_brewer(palette = "Blues")+
  # facet_grid(mergedSub~.)+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=90, vjust=1,hjust = 1))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))+
    theme(strip.text = element_blank())


q

# ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 5 )
ggsave(q,filename = "~/Documents/test.pdf",height = 3,width = 4)


```






- 接上：A B D亚基因组*固定*有害突变的比例及个数
```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2)) %>% 
  mutate(ifFixed = if_else(binStart < 0.8,"NotFixed","Fixed")) %>%
  group_by(Sub,LoadGroup,ifFixed) %>%
  summarise(sum_n = sum(n), sum_fre = sum(fre))

```

- 接上：A B D亚基因组*稀有*有害突变的比例及个数, 显著性检验
```{r}

df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  mutate(bin=cut_width(DAF,width = 0.05,boundary = 0)) %>% 
  group_by(Sub,LoadGroup) %>% 
  count(bin) %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(LoadGroup)) %>% 
  ungroup() %>% 
  mutate(binStart = round(as.numeric(str_sub(str_split_fixed(bin,",",2)[,1],2)),2)) %>% 
  mutate(ifFixed = if_else(binStart < 0.05,"Rare","NotRare")) %>%
  group_by(Sub,LoadGroup,ifFixed) %>%
  summarise(sum_n = sum(n), sum_fre = sum(fre))
```

显著性检验
```{r}
### 显著性检验，每个亚基因组内的有害同义和非同义突变进行显著性检验
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup =  ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  mutate(LoadGroup=as.factor(LoadGroup)) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  ### data deal
  filter(!is.na(DAF)) %>% 
  filter(DAF<0.05) 

df$Sub <- as.factor(df$Sub)
df$LoadGroup <- as.factor(df$LoadGroup)

dfA <- df %>% filter(Sub == "A")
dfB <- df %>% filter(Sub == "B")
dfD <- df %>% filter(Sub == "D")

pairwise.wilcox.test(dfA$DAF,dfA$LoadGroup,p.adjust.method = "BH")
print("*****************************************")
pairwise.wilcox.test(dfB$DAF,dfB$LoadGroup,p.adjust.method = "BH")
print("*****************************************")
pairwise.wilcox.test(dfD$DAF,dfD$LoadGroup,p.adjust.method = "BH")
print("*****************************************")

pairwise.wilcox.test(df$DAF,df$LoadGroup,p.adjust.method = "BH")



```



查看AABB群体daf最高值最低值
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>%
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  filter(Sub == "D")

min(df$DAF_AB,na.rm = T) 
max(df$DAF_AB,na.rm = T)

```


## ===========================
## Scatter for gerp and sift

```{r}
df2 <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  # mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  # mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  filter(!is.na(Gerp),!is.na(Derived_SIFT)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) 
  
df <- sample_n(df2,3000)

```


```{r}

df$LoadGroup <- factor(df$LoadGroup, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- df %>%
  ggplot(aes(x=Gerp,y=Derived_SIFT,fill=LoadGroup))+
  geom_point(size=2, shape=21,color="white",alpha=0.8)+
  # scale_color_manual(values = colB)+
  scale_fill_manual(values = colB)+
  labs(x="GERP score",y="SIFT score")+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    text = element_text(size = 12),legend.position = 'none')
   
p

# ggsave(p,filename = "~/Documents/test.pdf",height = 3.6*3/4,width = 3.6)
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```
### scale SIFT
```{r}
df$LoadGroup <- factor(df$LoadGroup, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

p <- df %>%
  ggplot(aes(x=Gerp,y=Derived_SIFT,fill=LoadGroup))+
  geom_point(size=2, shape=21,color="white",alpha=0.8)+
  # scale_color_manual(values = colB)+
  scale_fill_manual(values = colB)+
  scale_y_log10()+
  labs(x="GERP score",y="SIFT score")+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    text = element_text(size = 12),legend.position = 'none')
   
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3.6*3/4,width = 3.6)
```



## 3D

```{r}
df2 <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  # mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  # mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  filter(!is.na(Gerp),!is.na(Derived_SIFT)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) 
  
df <- sample_n(df2,5000)

```


```{r}

df$LoadGroup <- factor(df$LoadGroup, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")

library(carData)
library(car)
library(rgl)
scatter3d(x = df$Gerp, z = df$Derived_SIFT, y = df$DAF, groups = df$LoadGroup,
          surface=FALSE, grid = FALSE, ellipsoid = F,
          surface.col = colB
          ,xlab="GERP score"  
          ,zlab="SIFT score"
          ,ylab="DAF"
          )
rgl.postscript("figs/3D_scatterPlot.pdf",fmt="pdf")
```

### 等高线表示法
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  # mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  # mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  filter(!is.na(Gerp),!is.na(Derived_SIFT)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(LoadGroup=factor(LoadGroup, 
                          levels = c("Synonymous","Nonsynonymous","Deleterious"))) %>% 
  group_by(LoadGroup) %>% 
  slice_sample(prop = 1)
  # filter(LoadGroup == "Deleterious")
 
colB <- c("#004680","#e69f00","#d5311c")
 
p <- df %>%
  ggplot(aes(x=Gerp,y=Derived_SIFT,color=LoadGroup, fill=LoadGroup))+
  # ggplot(aes(x=Gerp,y=Derived_SIFT))+
  # geom_point(size=2, shape=21,color="white",alpha=0.8)+
  # geom_point(size=2,alpha=0.005)+
  # geom_bin2d(bins=70)+
  stat_density2d()+
  # scale_color_manual(values = colB)+
  # scale_fill_manual(values = colB)+
  # scale_fill_continuous(type = "viridis")+
  labs(x="GERP score",y="SIFT score")+
  # facet_grid(LoadGroup~.,scales = "free_y")+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    text = element_text(size = 12),legend.position = 'none')

p

# ggsave(p,filename = "~/Documents/test.pdf",height = 3.6*3/4,width = 3.6)
```
### 单变量直方图分布
```{r}
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS") %>% 
  # mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  # mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  filter(!is.na(Gerp),!is.na(Derived_SIFT)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<=0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral==Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(LoadGroup=factor(LoadGroup, 
                          levels = c("Synonymous","Nonsynonymous","Deleterious"))) %>% 
  group_by(LoadGroup) %>% 
  slice_sample(prop = 1)
  # filter(LoadGroup == "Deleterious")
 
colB <- c("#004680","#e69f00","#d5311c")
 
p <- df %>% 
 ggplot(aes(x=Derived_SIFT,fill = LoadGroup)) + 
 geom_histogram(alpha=0.8,position="identity",bins = 30)+
  # geom_density(alpha=.2) +
  facet_grid(LoadGroup~.,scales = "free_y")+
  scale_fill_manual(values = colB)+
  theme_classic()+
  # scale_color_manual(values = c("#00AFBB", "#E7B800"))+
  # scale_fill_manual(values = c("#00AFBB", "#E7B800"))+
  # theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  # scale_x_continuous(limits = c(-7,4),breaks = seq(-6.5,4,1.5))+
  # labs(x="SIFT score")+
  labs(x="GERP score")+
  theme(plot.margin=unit(rep(1,4),'lines'),
        legend.title = element_blank(),
        legend.position = "none",
        axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 20))
p
ggsave(p,filename = "~/Documents/test.pdf",height = 6,width = 8)
```





## ===========================

## ①Del and recombination on the whole genome
### step1:del 重组率和ratio 拟合到一个plot中
```{r}
library(ggplot2)
library(windowscanr)
library(stringr)
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
head(df)
str(df)
nrow(df)
### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$DelSynRatio))
df <- subset(df,!is.na(df$RecombinationRate))
### check del/syn 最大值和最小值
max(df$DelSynRatio)
min(df$DelSynRatio)
max(df$RecombinationRate)
min(df$RecombinationRate)
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

pos_win <- winScan(x = df, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("DelSynRatio", "RecombinationRate"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df <- pos_win
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```

### step2:adjust fig shape
```{r}
recom <- ggplot()+
  geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  geom_line(df, mapping=aes(x=df$win_start,y=DelSynRatio_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df, mapping=aes(x=df$win_start,y=df$DelSynRatio_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  geom_point()+
  geom_line(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  xlab("")+ylab("Del SNPs/syn SNPs") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(plot.margin=unit(rep(1,4),'lines'),panel.background = element_rect(size = 0.7, colour = 'black',fill = 'white'),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size = 12),legend.position = 'none')
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)

```

### step2:adjust fig shape remove R1 R2 region fill
```{r}
df_centromere_total <- read.delim("data/fig2/ChrLenCentPosi_wheat_addScalePosition.txt")
df_centromere <- data.frame(x = df_centromere_total$Scale100,y=rep(0.05,21))
  

recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df, mapping=aes(x=df$win_start,y=DelSynRatio_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df, mapping=aes(x=df$win_start,y=df$DelSynRatio_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  # geom_point()+
  geom_line(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
    # geom_point(df_centromere,mapping = aes(x=x,y=y),color='black',size=0.5)+
  xlab("Scale position")+ylab("Del SNPs/syn SNPs") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
# ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(recom,filename = "~/Documents/test.pdf",height = 3,width = 6)

```

## ✨不滑窗 del and recombination on the whole genome ###不滑窗
### step1:del 重组率和ratio 拟合到一个plot中
```{r}
library(ggplot2)
library(windowscanr)
library(stringr)
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
# head(df)
# str(df)
nrow(df)
### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$DelSynRatio))
df <- subset(df,!is.na(df$RecombinationRate))
### check del/syn 最大值和最小值
max(df$DelSynRatio)
min(df$DelSynRatio)
max(df$RecombinationRate)
min(df$RecombinationRate)
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

# pos_win <- winScan(x = df, 
#                    groups = "CHROM", 
#                    position = "BIN_START_scale" , 
#                    values = c("DelSynRatio", "RecombinationRate"), 
#                    win_size = 5,
#                    win_step = 2,
#                    funs = c("mean", "sd"))
# 
# head(pos_win)
# df <- pos_win
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```

```{r}
df_sample <- df %>% 
  sample_frac(0.1)
```

```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
    annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df_sample, mapping=aes(x=BIN_START_scale,y=DelSynRatio,group=CHROM),col='#F4A460')+
  stat_smooth(df_sample, mapping=aes(x=BIN_START_scale,y=DelSynRatio),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  # geom_point()+
  geom_line(df, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  xlab("")+ylab("Del SNPs/syn SNPs") +
  # coord_cartesian(ylim = c(0,1))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```



### step2:adjust fig shape
```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df, mapping=aes(x=BIN_START_scale,y=DelSynRatio,group=CHROM),col='#F4A460')+
  stat_smooth(df, mapping=aes(x=BIN_START_scale,y=DelSynRatio),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  geom_point()+
  geom_line(df, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  xlab("")+ylab("Del SNPs/syn SNPs") +
  coord_cartesian(ylim = c(0,1.5))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))

recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)

```

```{r}
a <- df_centromere_total$Scale100
max(a)
min(a)
```

## Nonsyn and recombination on the whole genome
### step1:del 重组率和ratio 拟合到一个plot中
```{r}
library(windowscanr)
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
head(df)
str(df)
nrow(df)
### 去除Nonsyn/SynRatio为NA的行
df <- subset(df,!is.na(df$NonsynSynRatio))
df <- subset(df,!is.na(df$RecombinationRate))
### check del/syn 最大值和最小值
max(df$NonsynSynRatio)
min(df$NonsynSynRatio)
max(df$RecombinationRate)
min(df$RecombinationRate)
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

pos_win <- winScan(x = df, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("DelSynRatio","NonsynSynRatio", "RecombinationRate"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df <- pos_win
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```
### step2:adjust fig shape and keep the R1 R3 region
```{r}
p <- ggplot()+
  geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  geom_line(df, mapping=aes(x=win_start,y=NonsynSynRatio_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df, mapping=aes(x=win_start,y=NonsynSynRatio_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  geom_point()+
  geom_line(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  xlab("")+ylab("Nonsyn SNPs/syn SNPs") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~./2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(plot.margin=unit(rep(1,4),'lines'),panel.background = element_rect(size = 0.7, colour = 'black',fill = 'white'),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size = 12),legend.position = 'none')
p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 6)

```
### step2:adjust fig shape remove R1 R2 region fill
```{r}
df_centromere_total <- read.delim("data/fig2/ChrLenCentPosi_wheat_addScalePosition.txt")
df_centromere <- data.frame(x = df_centromere_total$Scale100,y=rep(0.05,21))
  

recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df, mapping=aes(x=win_start,y=NonsynSynRatio_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df, mapping=aes(x=win_start,y=NonsynSynRatio_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  # geom_point()+
  geom_line(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2,group=CHROM),col='#56B4E9')+
  stat_smooth(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
    # geom_point(df_centromere,mapping = aes(x=x,y=y),color='black',size=0.5)+
  xlab("Scale position")+ylab("Nonsyn SNPs/syn SNPs") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~./2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
# ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(recom,filename = "~/Documents/test.pdf",height = 3,width = 6)
```

## ②用个体burden代替del SNP/ syn SNP and recombination on the whole genome
### step1:del 重组率和ratio 拟合到一个plot中
```{r}
library(ggplot2)
library(windowscanr)
library(stringr)
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
head(df)
str(df)
nrow(df)
### 去除DelSynRatio为NA的行
# df <- subset(df,!is.na(df$DelSynRatio))
df <- subset(df,!is.na(df$RecombinationRate))
### check del/syn 最大值和最小值
max(df$DelSynRatio)
min(df$DelSynRatio)
max(df$RecombinationRate)
min(df$RecombinationRate)
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

pos_win <- winScan(x = df, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("DelSynRatio", "RecombinationRate"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df <- pos_win
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```

```{r}

dataFile <- c("data/fig2/indiviBurdenbyGene/002_geneExpression_StronglyLoad_addScalePosition.txt")
df_load <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL) %>% 
  filter(!is.na(mean_burden), is.finite(mean_burden)) %>% 
  select(CHROM,BIN_START_scale = TranStart_Scale,mean_burden)

### check del/syn 最大值和最小值
max(df_load$mean_burden)
min(df_load$mean_burden)


pos_win <- winScan(x = df_load, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("mean_burden"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df_load_window <- pos_win %>% mutate(Sub=substring(CHROM,2,2))
df_load_window <- df_load_window %>% filter(!is.na(mean_burden_mean))
```


### step2:adjust fig shape remove R1 R2 region fill
```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df_load_window, mapping=aes(x=win_start,y=mean_burden_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df_load_window, mapping=aes(x=win_start,y=mean_burden_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  # geom_point()+
  # geom_line(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/3,group=CHROM),col='#56B4E9')+
  # stat_smooth(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/3),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
    # geom_point(df_centromere,mapping = aes(x=x,y=y),color='black',size=0.5)+
  xlab("Scale position")+ylab("Strongly burden") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  # scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*3, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
# ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(recom,filename = "~/Documents/test.pdf",height = 3,width = 6)

```


## 用个体burden代替nonsyn SNP/ syn SNP and recombination on the whole genome
### step1:del 重组率和ratio 拟合到一个plot中
```{r}
library(ggplot2)
library(windowscanr)
library(stringr)
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
head(df)
str(df)
nrow(df)
### 去除DelSynRatio为NA的行
# df <- subset(df,!is.na(df$DelSynRatio))
df <- subset(df,!is.na(df$RecombinationRate))
### check del/syn 最大值和最小值
max(df$DelSynRatio)
min(df$DelSynRatio)
max(df$RecombinationRate)
min(df$RecombinationRate)
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

pos_win <- winScan(x = df, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("DelSynRatio", "RecombinationRate"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df <- pos_win
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```

```{r}

dataFile <- c("data/fig2/indiviBurdenbyGene/002_geneExpression_SlightlyLoad_addScalePosition.txt")
df_load <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL) %>% 
  filter(!is.na(mean_burden), is.finite(mean_burden)) %>% 
  select(CHROM,BIN_START_scale = TranStart_Scale,mean_burden)

### check del/syn 最大值和最小值
max(df_load$mean_burden)
min(df_load$mean_burden)


pos_win <- winScan(x = df_load, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("mean_burden"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

head(pos_win)
df_load_window <- pos_win %>% mutate(Sub=substring(CHROM,2,2))
df_load_window <- df_load_window %>% filter(!is.na(mean_burden_mean))
```


### step2:adjust fig shape remove R1 R2 region fill
```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df_load_window, mapping=aes(x=win_start,y=mean_burden_mean,group=CHROM),col='#F4A460')+
  stat_smooth(df_load_window, mapping=aes(x=win_start,y=mean_burden_mean),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  # geom_point()+
  # geom_line(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/3,group=CHROM),col='#56B4E9')+
  # stat_smooth(df, mapping=aes(x=df$win_start,y=df$RecombinationRate_mean/3),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
    # geom_point(df_centromere,mapping = aes(x=x,y=y),color='black',size=0.5)+
  xlab("Scale position")+ylab("Strongly burden") +
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  # scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*3, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
# ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(recom,filename = "~/Documents/test.pdf",height = 3,width = 6)

```


## ③用个体 sum 代替个体budrden ,recombination on the whole genome

### StronglyBurden
```{r}
library(windowscanr)
library(stringr)

dataFile <- c("data/geneExpression/geneBurdenByIndi/002_geneBurden_byIndiviSum_addPosition.txt.gz")
df <- read.delim(dataFile)

pos_win <- winScan(x = df,
                   groups = "CHROM",
                   position = "BIN_START_scale" ,
                   values = c("synNum", "nonNum","delNum"),
                   win_size = 5,
                   win_step = 2,
                   funs = c("sum"))

# head(pos_win)
df_load <- pos_win
```

```{r}
df_load2 <- df_load %>% mutate(StronglyBurden = delNum_sum/synNum_sum, SlightlyBurden = nonNum_sum/synNum_sum, Sub = substring(CHROM,2,2)) %>% 
  select(-c(synNum_n:delNum_sum))
```

```{r}
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL)
# head(df)
# str(df)
### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate))
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))
df <- mutate(df,Sub=substring(df$CHROM,2,2))

```

```{r}
df_sample <- df %>% 
  sample_frac(0.1)
```

```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
    annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
    geom_line(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2,group=CHROM),col='#56B4E9',size=0.2)+

  geom_line(df_load2, mapping=aes(x=win_start,y=StronglyBurden,group=CHROM),col='#F4A460',size=0.2)+
  stat_smooth(df_load2, mapping=aes(x=win_start,y=StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  
  # geom_point()+
  stat_smooth(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  xlab("")+ylab("Strongly Burden") +
  # coord_cartesian(ylim = c(0,1))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```
### SlightlyBurden
```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
    annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
    geom_line(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/4,group=CHROM),col='#56B4E9',size=0.2)+

  # geom_line(df_load2, mapping=aes(x=win_start,y=StronglyBurden,group=CHROM),col='#F4A460',size=0.2)+
  # stat_smooth(df_load2, mapping=aes(x=win_start,y=StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +

    geom_line(df_load2, mapping=aes(x=win_start,y=SlightlyBurden,group=CHROM),col='#F4A460',size=0.2)+
  stat_smooth(df_load2, mapping=aes(x=win_start,y=SlightlyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +

  
  # geom_point()+
  stat_smooth(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/4),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  xlab("")+ylab("Slightly Burden") +
  # coord_cartesian(ylim = c(0,0.6))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*4, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```

### 一张图：slightlyBurden stronglyBurden 画在一张图上
```{r}
recom <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
    annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
    # geom_line(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/4,group=CHROM),col='#56B4E9',size=0.2)+

  geom_line(df_load2, mapping=aes(x=win_start,y=StronglyBurden,group=CHROM),col='#F4A460',size=0.2)+
  stat_smooth(df_load2, mapping=aes(x=win_start,y=StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +

    geom_line(df_load2, mapping=aes(x=win_start,y=SlightlyBurden,group=CHROM),col='#F4A460',size=0.2)+
  stat_smooth(df_load2, mapping=aes(x=win_start,y=SlightlyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  # geom_point()+
  # stat_smooth(df_sample, mapping=aes(x=BIN_START_scale,y=RecombinationRate/4),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  xlab("")+ylab("Strongly Burden") +
  # coord_cartesian(ylim = c(0,0.6))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_y_continuous(expand = c(0, 0),sec.axis = sec_axis(~.*4, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```

### norm slightlyBurden VS stronglyBurden
```{r}
StrongMean <- mean(df_load2$StronglyBurden, na.rm = T)
StrongSD <- sd(df_load2$StronglyBurden, na.rm = T)
SlightlyMean <- mean(df_load2$SlightlyBurden, na.rm = T)
SlightlySD <- sd(df_load2$SlightlyBurden, na.rm = T)
df_load2_norm <- df_load2 %>%
  mutate(Norm_StronglyBurden=(StronglyBurden-StrongMean)/StrongSD, 
         Norm_SlightlyBurden=(SlightlyBurden-SlightlyMean)/SlightlySD)
  
recom <- ggplot()+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  geom_line(df_load2_norm, mapping=aes(x=win_start,y=Norm_StronglyBurden,group=CHROM),col='#F4A460',size=0.2)+
  stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=Norm_StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
    geom_line(df_load2_norm, mapping=aes(x=win_start,y=Norm_SlightlyBurden,group=CHROM),col='green',size=0.2)+
  stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=Norm_SlightlyBurden),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  xlab("")+ylab("Mutation Burden") +
  coord_cartesian(ylim = c(-1,1.2))+
  theme(legend.position = 'none')+
  scale_fill_manual(values = colB)+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7)
    ,legend.position = 'none'
    ,text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```

### syn nonsyn del 标准化后的count
```{r}
StrongMean <- mean(df_load$delNum_sum, na.rm = T)
StrongSD <- sd(df_load$delNum_sum, na.rm = T)
SlightlyMean <- mean(df_load$nonNum_sum, na.rm = T)
SlightlySD <- sd(df_load$nonNum_sum, na.rm = T)
SynMean <- mean(df_load$synNum_sum, na.rm = T)
SynSD <- sd(df_load$synNum_sum, na.rm = T)
df_load2_norm <- df_load %>%
  mutate(Norm_StronglyBurden=(delNum_sum-StrongMean)/StrongSD, 
         Norm_SlightlyBurden=(nonNum_sum-SlightlyMean)/SlightlySD,
         Norm_syn=((synNum_sum-SynMean)/SynSD)) %>% 
  mutate(normStronglyRatio = Norm_StronglyBurden/Norm_syn,normSlightlyRatio=Norm_SlightlyBurden/Norm_syn)
  

recom <- ggplot()+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=Norm_StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=Norm_SlightlyBurden),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=Norm_syn),col = "green",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  
  # ### ratio
  #   stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=normStronglyRatio),col = "purple",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +
  # stat_smooth(df_load2_norm, mapping=aes(x=win_start,y=normSlightlyRatio),col = "pink",method = "loess",formula = y~x,span = 0.04,se=F,size=1.1) +

  
  xlab("")+ylab("Strongly Burden") +
  # coord_cartesian(ylim = c(0,0.6))+
  scale_fill_manual(values = colB)+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    text = element_text(size = 12))
recom
ggsave(recom,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
```
## ✨🌛④muation burden by ave individual burden
- 由于单个个体按照基因计算的的mutation burden比较小，有很多NA出现，因此所有个体在每个基因上的平均值也会出现很多NA值。为了避免此种情况发生，每个个体进行较大滑窗后进行mutation burden计算，再求所有个体在此滑窗内的平均值。
```{r}
### step1:提取3列主要信息，并合并文件
# individualCountDir <- "data/geneExpression/003_burden_vs_expression"
# individualCountFiles <- list.files(individualCountDir)
# df_delCountList <- vector(mode = "list", length = length(individualCountFiles))
# for (i in seq_along(individualCountFiles)) {
#   df_delCountList[[i]] <- read_delim(file.path(individualCountDir, individualCountFiles[i]),delim = "\t") %>%
#     mutate(Taxa=str_replace(individualCountFiles[[i]], ".txt.gz","")) %>%
#     select(geneName,numDerivedInSyn,numDerivedInNonsyn,numDerivedInHGDeleterious,Taxa)
# }
# 
# df_delCount <- bind_rows(df_delCountList)
# 
# write_delim(df_delCount, "data/geneExpression/004_burden_merged/GeneDerivedCount_byIndivi.txt.gz", delim = "\t")

# df_delCount <- read_delim("data/geneExpression/004_burden_merged/GeneDerivedCount_byIndivi.txt.gz",delim = "\t")
```

```{r}
### step2:为基因添加位置信息,即leftjoin CHROM等位置，并按照scale后的pos进行滑窗。
# genePosFile <- "data/geneExpression/geneBurdenByIndi/002_geneBurden_byIndiviSum_addPosition.txt.gz"
# df_genePos <- read_delim(genePosFile, delim = "\t") %>%
#   select(geneName, CHROM, BIN_START,BIN_END,BIN_START_scale)

### build function
# library(windowscanr)
# slideWindow <- function(df){
#   pos_win <- winScan(x = df,
#                    groups = "CHROM",
#                    position = "BIN_START_scale" ,
#                    values = c("numDerivedInSyn","numDerivedInNonsyn","numDerivedInHGDeleterious"),
#                    win_size = 5,
#                    win_step = 2,
#                    funs = c("sum"))
#     return(pos_win)
# }

### invoke function
# df_count_windowslide <- df_delCount %>%
#   left_join(y = df_genePos, by = c("geneName")) %>%
#   group_by(Taxa) %>%
#     group_modify(~{.x %>% slideWindow()})

# df_indiviCount_slide <- df_burden


  # map_dfr(.f = winScan(x = ., groups = "CHROM", 
  #       position = "BIN_START_scale" , 
  #                  values = c("numDerivedInSyn","numDerivedInNonsyn","numDerivedInHGDeleterious"), 
  #                  win_size = 5,
  #                  win_step = 2,
  #                  funs = c("sum")))

# df_indiviBurden <- df_burden

```

```{r}
### 将滑窗后的结果写出，保存
# write_delim(df_count_windowslide, "data/geneExpression/004_burden_merged/GeneDerivedCount_byIndivi_slidewindow.txt.gz", delim = "\t")
```


```{r}
### step3:滑窗后，先分组，按照染色体，起始位置，个体为单位，计算每个个体在每条染色体每个Bin的总的derived syn,nonsyn,del。
### 根据count 之和，求出每个个体每个bin的burden,再求每个bin的所有个体的平均值
df_count_windowslide <- read.delim("data/geneExpression/004_burden_merged/GeneDerivedCount_byIndivi_slidewindow.txt.gz")

df_load <- df_count_windowslide %>% 
  mutate(StronglyBurden = numDerivedInHGDeleterious_sum/numDerivedInSyn_sum, SlightlyBurden = numDerivedInNonsyn_sum/numDerivedInSyn_sum, Sub = substring(CHROM,2,2)) %>% 
  group_by(CHROM,win_start) %>% 
  summarise(ave_StronglyBurden = mean(StronglyBurden),ave_SlightlyBurden = mean(SlightlyBurden))
  
```


```{r}
### 导入重组率数据
dataFile <- c("data/001_delVSsynOnChr_10000000Window1000000step_addEffectiveCDSLength.txt_addRecombination.txt")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL) %>% 
  filter(!is.na(RecombinationRate)) %>% ### 去除DelSynRatio为NA的行
  mutate(Sub=substring(CHROM,2,2))
  
colB <- c("#fffcd4","#1e3c84","#3ab4c4","#3ab4c4","#1e3c84")
rec <- data.frame(x1=c(0,9,28,50,80), x2=c(9,28,50,80,100), y1=c(-Inf,-Inf,-Inf,-Inf,-Inf), y2=c(Inf,Inf,Inf,Inf,Inf), region=c('R1','R2a','C','R2b','R3'))

pos_win <- winScan(x = df, 
                   groups = "CHROM", 
                   position = "BIN_START_scale" , 
                   values = c("RecombinationRate"), 
                   win_size = 5,
                   win_step = 2,
                   funs = c("mean", "sd"))

df <- pos_win
```

```{r}
### 抽样重组率数据
df_sample <- df %>% 
  sample_frac(0.1)
```

```{r}
### Strongly load distribution

df_load2 <- df_load %>% 
  filter(!is.na(ave_StronglyBurden), is.finite(ave_StronglyBurden))

p <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  # geom_point()+
  ### 重组率linechart
  geom_line(df, mapping=aes(x=win_start,y=RecombinationRate_mean/2,group=CHROM),col='#56B4E9')+
  geom_line(df_load2, mapping=aes(x=win_start,y=ave_StronglyBurden,group=CHROM),col='#F4A460')+
    stat_smooth(df, mapping=aes(x=win_start,y=RecombinationRate_mean/2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  stat_smooth(df_load2, mapping=aes(x=win_start,y=ave_StronglyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +

  xlab("Scale position")+ylab("Strongly mutation burden") +
  coord_cartesian(ylim = c(0,1))+
  scale_y_continuous(breaks = seq(0,1,0.25),expand = c(0, 0),sec.axis = sec_axis(~.*2, name="Recombination rate"))+
  scale_x_continuous(expand = c(0, 0))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    legend.position = 'none',
    text = element_text(size = 12))

p
# ggsave(p,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 6)


```

```{r}
### Slightly load distribution
df_load2 <- df_load %>% 
  filter(!is.na(ave_StronglyBurden), is.finite(ave_StronglyBurden))

p <- ggplot()+
  # geom_rect(data=rec, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2,fill=region))+
  annotate(geom = "rect", xmin = 28.14,xmax = 53.08, ymin = -Inf, ymax = Inf, fill = "#fffcd4",alpha = 1)+
  # geom_point()+
  ### 重组率linechart
  geom_line(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2,group=CHROM),col='#56B4E9')+
  geom_line(df_load2, mapping=aes(x=win_start,y=ave_SlightlyBurden,group=CHROM),col='#F4A460')+
    stat_smooth(df, mapping=aes(x=win_start,y=RecombinationRate_mean*2),col = "blue",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +
  stat_smooth(df_load2, mapping=aes(x=win_start,y=ave_SlightlyBurden),col = "#d5311c",method = "loess",formula = y~x,span = 0.04,se=F,size=1.3) +

  xlab("Scale position")+ylab("Slightly mutation burden") +
  scale_y_continuous(breaks = seq(0,4,1),expand = c(0, 0),sec.axis = sec_axis(~./2, name="Recombination rate",breaks = seq(0,2,0.5)))+
  scale_x_continuous(expand = c(0, 0))+
  coord_cartesian(ylim = c(0,4))+
  theme(
    # plot.margin=unit(rep(1,4),'lines'),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    legend.position = 'none',
    text = element_text(size = 12))

p
# ggsave(p,filename = "~/Documents/test.pdf",height = 4/2,width = 4)
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 6)

```




##=====================
## Gene variant count 
```{r}
library(forcats)
dataFile <- c("/Users/Aoyue/project/wheatVMapII/003_dataAnalysis/005_vcf/033_annoDB/010_countGenevariants/004_001filterby003/001_gene_variantsCount_byMAF_variantsType_AABBDD.txt.gz")
df <- read.table(dataFile, header=TRUE, sep="\t",row.names=NULL) ##3s read 56.9M
head(df)
nrow(df)
# df <- subset(df,df$Sub=="A")
df <- subset(df,df$Sub=="B")
# df <- subset(df,df$Sub=="D")
nrow(df)
df <- df[c(1:2100),]
# df <- df %>% gather(.,key="CommonOrRare",value = "Count",c(3:4))
# df <- sample_n(df,1000)
df <- mutate(df,Gene=fct_reorder(Gene,RareVariants))
colB <- c("#d5311c","#e69f00","#004680")
p <- ggplot(df)+
  geom_bar(aes(x=df$Gene,y=-df$RareVariants,fill=df$VariantsType),stat = 'identity')+
  # geom_text(aes(x=Gene,y=RareVariants,label=RareVariants),size=4)+
  geom_bar(aes(x=df$Gene,y=df$CommonVariants,fill = df$VariantsType),stat = 'identity')+
  # geom_text(aes(x=df$Gene,y=df$Flip_CommonVariants,label=df$Flip_CommonVariants),size=4)+
  geom_segment(x=0,xend= 100000,y=0,yend=0,size=0.5,color='white')+
  annotate("text",x=-Inf,y= 0 ,hjust=-0.3,vjust=3,label="MAF <= 5%")+
  annotate("text",x=-Inf,y= 0,hjust=-0.3,vjust=-3,label="MAF > 5%")+
  scale_y_continuous(limit = c(-220,50), breaks = seq(-200,50,50),labels = c(200,150,100,50,0,50))+
  xlab("")+ylab("")+
  scale_fill_manual(values = colB,name="")+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_blank(),axis.ticks.x = element_blank(),axis.line.x = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))
p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 3.6)
```


### new code
```{r}
### 记得导入dftotal 数据框

df_stage1 <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  # select(Variant_type,Derived_SIFT,Gerp,LoadGroup)
  group_by(Transcript,CommonOrRare) %>% 
  count(LoadGroup) %>% 
  mutate(Sub = str_sub(Transcript,9,9)) %>% 
  spread(key = CommonOrRare, value = n,fill = 0)

```
接上，
```{r}
### 计算多少个基因含有突变
genenum <- length(unique(df_stage1$Transcript))
print(paste("genenum",genenum))

### 计算有多少个基因即有稀有变异,又有common变异
dfgenenum <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  # select(Variant_type,Derived_SIFT,Gerp,LoadGroup)
  group_by(Transcript) %>% 
  count(CommonOrRare)

dftest <- dfgenenum %>% 
  group_by(Transcript) %>% 
  count(Transcript) %>% 
  filter(n==2)

print(paste("gene num with rare and coomn", nrow(dftest)))

### 计算有多少个基因只有稀有变异，或者只有common变异
dftest <- dfgenenum %>% 
  group_by(Transcript) %>% 
  count(Transcript) %>% 
  filter(n==1) %>% 
  left_join(.,dfgenenum,by="Transcript") %>% 
  group_by(CommonOrRare) %>% 
  count(CommonOrRare)

print("gene num with only rare snp 21457")
print("gene num with only common snp 2195")

### 有害变异在基因中的分布：分类三类基因1.common 2.rare 3.common and rare
### 1.rare
dfrare <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(LoadGroup == "Deleterious") %>%
  group_by(Transcript) %>% 
  count(Transcript)

dftest <- dfgenenum %>% 
  group_by(Transcript) %>% 
  count(Transcript) %>% 
  filter(n==1) %>% 
  left_join(.,dfgenenum,by="Transcript") %>% 
  filter(CommonOrRare=="Rare") %>% 
  left_join(.,dfrare,by="Transcript") %>% 
  filter(!is.na(n))

 print("gene num with only rare snp 8099 (has deleterious)")

### 2. common
  dfrare <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(LoadGroup == "Deleterious") %>%
  group_by(Transcript) %>% 
  count(Transcript)

dftest <- dfgenenum %>% 
  group_by(Transcript) %>% 
  count(Transcript) %>% 
  filter(n==1) %>% 
  left_join(.,dfgenenum,by="Transcript") %>% 
  filter(CommonOrRare=="Common") %>% 
  left_join(.,dfrare,by="Transcript") %>% 
  filter(!is.na(n))

 print("gene num with only common snp 226 (has deleterious)")
 
 
 ### 3. common and rare
  dfrare <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(LoadGroup == "Deleterious") %>%
  group_by(Transcript) %>% 
  count(Transcript)

dftest <- dfgenenum %>% 
  group_by(Transcript) %>% 
  count(Transcript) %>% 
  filter(n==2) %>% 
  left_join(.,dfgenenum,by="Transcript") %>% 
  distinct(.,Transcript) %>% 
  left_join(.,dfrare,by="Transcript") %>% 
  filter(!is.na(n))

 print("gene num with common and rare snp 16633 (has deleterious)")


```

开始画图
```{r}

### 含有 common 基因的基因列表
dfcommon <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  # select(Variant_type,Derived_SIFT,Gerp,LoadGroup)
  group_by(Transcript) %>% 
  count(CommonOrRare) %>% 
  filter(CommonOrRare == "Common") %>% 
  distinct(.,Transcript) 

### 含有 rare 基因的基因列表
dfrare <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  # select(Variant_type,Derived_SIFT,Gerp,LoadGroup)
  group_by(Transcript) %>% 
  count(CommonOrRare) %>% 
  filter(CommonOrRare == "Rare") %>% 
  distinct(.,Transcript) 



library(VennDiagram)
#Make the plot
venn.diagram(
  x = list(dfcommon$Transcript,dfrare$Transcript), 
  main = "common and rare genes",
  category.names = c("common" , "rare" ),
  filename = "gene statistic.png",
  output = T ,
  
  # Output features
  imagetype="png" ,
  # height = 480 , 
  # width = 480 , 
  # resolution = 300,
  # compression = "lzw",
  
  # Circles
  lwd = 1,
  col=c("#440154ff", '#21908dff'),
  fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3)),
  
  # Numbers
  cex = 0.5,
  fontfamily = "sans",
  cat.cex = 0.3,
  cat.default.pos = "outer",
  ## cat.pos = c(-27, 27, 135),
  ## cat.dist = c(0.055, 0.055, 0.085),
  cat.pos = c(-27, 27),
  cat.dist = c(0.055, 0.055),
  cat.fontfamily = "sans",
  cat.col = c("#440154ff", '#21908dff')
  # rotation = 1
)
```

```{r}
ggplot(df_common_rare,aes(x=n))+
  geom_histogram()
median(df_common_rare$n)
mean(df_common_rare$n)
```

接上
```{r}
## 每个基因至少出现3次，即每个基因至少含有Synonymous Nonsynonymous Deleterious
## 过滤后，每个基因按照rare的总数进行排序，由低到高，并进行间隔抽样，抽取100个试试看

## 每个基因含有的rare变异的分布范围
df_common_rare <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  group_by(CommonOrRare) %>% 
  count(Transcript) %>% 
  ungroup() %>% 
  filter(CommonOrRare == "Rare") %>% 
  select(Transcript,n)

df_filter <- df_stage1 %>% 
  count(Transcript) %>% 
  filter(n == 3) %>% 
  select(Transcript) %>% 
  left_join(.,df_common_rare,by="Transcript") %>% 
  rename(RareVariantsCount = n) %>% 
  filter(!is.na(RareVariantsCount)) %>% 
  ungroup()
  ### nuique 一下计数

df_sample <- df_filter %>% 
  distinct(RareVariantsCount,.keep_all=TRUE) %>% 
  arrange(RareVariantsCount)

```

接上
```{r}
df <- df_sample %>% 
  left_join(.,df_stage1,by="Transcript") %>% 
  rename(Gene = Transcript)

## 处理抽样基因的CDS长度
df_geneHC <- read.delim("data/fig2/geneHC.txt")

df_geneHC <- df_geneHC %>% select(Longest_transcript,CDSLength) %>% 
  rename(Transcript=Longest_transcript)

df_geneCDSlength <- df_sample %>% 
  left_join(.,df_geneHC,by="Transcript") %>% 
  rename(Gene = Transcript)

### 接下来看每个基因的长度，也画到图上，表示基因长度和变异数的关系
```

```{r}
colB <- c("#d5311c","#e69f00","#004680")
p <- ggplot()+
  geom_bar(data = df, mapping = aes(x=reorder(Gene,RareVariantsCount) ,y=-Rare,fill=LoadGroup),stat = 'identity')+
  geom_bar(data = df, mapping = aes(x=Gene,y=Common,fill = LoadGroup),stat = 'identity')+
  geom_segment(x=0,xend= 100000,y=0,yend=0,size=1,color='white')+
  geom_line(data = df_geneCDSlength,mapping = aes(x=Gene,y= 7*CDSLength/1000,group = 1),color = "gray")+
  annotate("text",x=-Inf,y= 0 ,hjust=-0.3,vjust=4,label="MAF <= 5%",size=3)+
  annotate("text",x=-Inf,y= 0,hjust=-0.3,vjust=-4,label="MAF > 5%",size=3)+
  scale_y_continuous(limit = c(-200,120), breaks = seq(-200,100,50),labels = c(200,150,100,50,0,50,100)
                     ,sec.axis = sec_axis(~./7, name="CDS length (kb)",breaks = seq(0,15,5))
                     )+
  xlab("Gene rank (by number of rare coding SNVs)")+ylab("Number of variants")+
  scale_fill_manual(values = colB,name="")+
  theme(legend.position = 'none')+
  scale_x_discrete(limits = df_sample$Transcript, breaks = c("TraesCS1A02G048500.1","TraesCS1A02G050200.1","TraesCS1B02G059500.1","TraesCS1A02G439500.1","TraesCS1D02G386205.1")
                   ,labels = c(1,25,50,75,100)
                   )+
  # theme(axis.text.x = element_blank(),axis.ticks.x = element_blank(),axis.line.x = element_blank())+
  theme(panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),text = element_text(size = 12))
p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 6)

```




```{r}
### 稀有变异数分布

df_filter %>% 
  ggplot(aes(x=.$RareVariantsCount))+
  geom_histogram()
```


数目统计
```{r}
## 每个基因含有的变异数范围
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  count(Transcript) 

## 1-199 个变异

## 每个基因含有的common和rare变异的分布范围
df <- dftotal %>% filter(Region=="CDS",Variant_type=="SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  group_by(CommonOrRare) %>% 
  count(Transcript) %>% 
  summarise(maxNum = max(n),minNum = min(n))



## 每个基因含有的不同loadGroup变异的分布范围
df <- dftotal %>% filter(Region=="CDS",Variant_type == "SYNONYMOUS"|Variant_type=="NONSYNONYMOUS")%>% 
  mutate(Derived_SIFT = ifelse(is.na(Derived_SIFT),100,Derived_SIFT)) %>% 
  mutate(Gerp = ifelse(is.na(Gerp),-100,Gerp)) %>% 
  mutate(LoadGroup = ifelse(Variant_type=="NONSYNONYMOUS",ifelse(Derived_SIFT<0.05&Gerp>=1,"Deleterious","Nonsynonymous"),"Synonymous")) %>% 
  filter(!Ancestral == "NA") %>% 
  filter(Ancestral== Ref|Ancestral==Alt) %>% 
  mutate(IfRefisAnc = if_else(Ref == Ancestral,"Anc","Der")) %>% 
  mutate(CommonOrRare = if_else(Maf <= 0.05, "Rare","Common")) %>%  ### 特别注意，这里根据MAF进行分组，按照维基百科的定义
  group_by(LoadGroup) %>% 
  count(Transcript) %>% 
  summarise(maxNum = max(n),minNum = min(n))

```

## ===================
## ********* Extended Data =====
## ===================

## VariantsType count totally only CDS region
- 外显子区所有load的计数
```{r}
### 含有比例和计数
df_variantsType <- dftotal %>% 
  filter(!is.na(Variant_type)) %>%
  group_by(Variant_type) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(desc(Variant_type))

colB <- c("#a9a9a9","#e69f00","#871f12","#d5311c","#5a150c","#004680")
p <- df_variantsType %>%
ggplot(aes(x=Variant_type,y=n,fill=Variant_type))+
  geom_bar(stat = 'identity',position = "stack")+
  # geom_text(aes(label=n),size=3,nudge_y = 1)+
    geom_text(aes(label=paste(n,"\n(",round(fre,3),")",sep = "")),size=3,
            position = position_dodge(0.9))+
  labs(x="", y="SNP count")+
  # scale_fill_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(legend.position = "none",plot.margin=unit(rep(1,4),'lines'),
          axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```
### by sub
```{r}
df_variantsType <- dftotal %>% group_by(Variant_type,Sub) %>% 
  filter(!is.na(Variant_type)) %>%
  summarise(n=n()) %>% 
  ungroup() %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(Sub,desc(Variant_type))

colB <- c("#a9a9a9","#e69f00","#871f12","#d5311c","#5a150c","#004680")

p <- df_variantsType %>%
ggplot(aes(x=Sub,y=n,fill=Variant_type))+
  geom_bar(stat = 'identity',position = "dodge")+
  geom_text(aes(label=paste(n,"\n(",round(fre,3),")",sep = "")),size=3,
            position = position_dodge(0.9))+
  labs(x="", y="SNP count")+
  # scale_fill_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  # theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(legend.position = "none",plot.margin=unit(rep(1,4),'lines'),
          axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 10))
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```

## Variants type CDS and noncoding region

```{r}
### Goal: 将 Region列和Variant_type列柔和在一起，成为新的一列，即将UTR的信息加入分析
### 第一步，Region 列，是 UTR_3 UTR_5的，新列就命名为UTR，不是的，则按照Variant_type类型添加

dfUTR <- dftotal %>% 
  filter(Region == "UTR_3" | Region == "UTR_5") %>% 
  mutate(VariantGroup = "UTR")

dfnotUTR <- dftotal %>% 
  filter(Region == "CDS") %>% 
  mutate(VariantGroup = Variant_type)

dfnew <- rbind(dfUTR,dfnotUTR)

df_variantGroup<- dfnew %>% 
  filter(!is.na(VariantGroup)) %>%
  group_by(VariantGroup) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  mutate(fre=n/sum(n)) %>% 
  arrange(desc(VariantGroup))

# colB <- c("#a9a9a9","#e69f00","#871f12","#d5311c","#5a150c","#004680")
colB <- c("#e69f00","#871f12","#d5311c","#5a150c","#004680","#a9a9a9")

df_variantGroup$VariantGroup <- factor(df_variantGroup$VariantGroup,levels = c("NONSYNONYMOUS","START-LOST","STOP-GAIN", "STOP-LOSS","SYNONYMOUS","UTR"), labels = c("Nonsynonymous","Start-lost", "Stop-gain","Stop-loss","Synonymous","UTR"))
p <- df_variantGroup %>%
ggplot(aes(x=VariantGroup,y=n,fill=VariantGroup))+
  geom_bar(stat = 'identity',position = "stack")+
  # geom_text(aes(label=n),size=3,nudge_y = 1)+
    geom_text(aes(label=paste(n,"\n(",round(fre,3),")",sep = "")),size=3,
            position = position_dodge(0.9))+
  labs(x="", y="SNP count")+
  # scale_fill_brewer(palette = "Set2")+
  scale_fill_manual(values = colB)+
  # scale_fill_brewer(palette = "Blues")+
  theme_classic()+
  theme(axis.text.x= element_text(angle=45, vjust=1,hjust = 1))+
  theme(legend.position = "none",plot.margin=unit(rep(1,4),'lines'),
          axis.line = element_line(size=0.4, colour = "black"),text = element_text(size = 12))
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)
```

## ===================
## Gene count
```{r}
df <- read.delim("data/fig2/geneCount/geneCount.txt")
head(df)
colB <- c("#d5311c","gray")
p <- df %>% 
  ggplot(aes(x=Group1, y=Count,fill=Group2)) +
  geom_bar(stat="identity",alpha = 1)+  #,position=position_dodge()
  geom_text(aes(label=prettyNum(Count,big.mark = ",")),position =  position_stack(),vjust=1.5, size=3) +
  scale_fill_manual(values=colB)+
  # ylab("SNP count (kb)") +
  labs(y="Gene count",x="")+
  theme(axis.text.x = element_text(vjust = 1, hjust = 1, angle = 45))+
  theme(panel.background = element_rect(size = 0.7, colour = 'black',fill = 'white'),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size = 12)
        ,legend.position = 'none'
        )

p


ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

```


## ===================

## correlation of recombination and nonsyn/syn
### 1.nonsyn per cds
```{r}
## 10M window 1M step 
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.delim(dataFile)
nrow(df) ##14075
### 去除Nonsyn/SynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate)) ##13807
head(df)
df <- gather(df,key = "VariantType",value = "CountPerSite", c(NonsynCountPerSite,SynCountPerSite))
levels(as.factor(df$VariantType))
df <- mutate(df, Sub = substring(df$CHROM,2,2))
colB <- c("#e69f00","#004680")
p <- df %>% 
  sample_frac(0.1) %>% 
  ggplot(aes(x=RecombinationRate,y=CountPerSite,color=VariantType))+
  geom_point(alpha=0.3,size=2)+
  scale_x_continuous(trans='log10') +
  stat_smooth(method = "lm", formula = y ~ x, se = FALSE)+
  stat_cor(
    aes(group=VariantType,label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.05,0.05) ,label.y.npc =c(0.65,0.95),size= 3
  )+
  # stat_cor(aes(group=VariantType),label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.25,0.65),size= 3 ) + ##绝对位置 label.x = 100, label.y = 0.0075
  stat_regline_equation(aes(group=VariantType),label.x.npc = c(0.05,0.05),label.y.npc = c(0.7,1),size= 3)+
  scale_color_manual(values = colB,name="",breaks=c("NonsynCountPerSite","SynCountPerSite"),labels = c("Nonsynnonymous mutations","Synonymous mutations"))+
  xlab("Recombination rate") + ylab("Frequency of mutation\n(SNP count per CDS length)")+
  scale_y_continuous(limits = c(0,0.015))+
  facet_wrap(~Sub,scales = "free_y")+
  theme_classic()+
  theme(strip.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.4, colour = "black")
      # ,legend.key = element_blank(),legend.spacing.y = unit(0, "mm")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
  
p
  
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 10)
```

### 2.nonsyn/syn

```{r}
## 10M window 1M step 
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.delim(dataFile)
nrow(df) ##14075
str(df)
nrow(df) ##14075

### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate)) ##13807
df <- subset(df,!is.na(df$NonsynSynRatio)) ##13807
df <- mutate(df, Sub = substring(df$CHROM,2,2))
p <- df %>% 
    sample_frac(0.1) %>% 
  ggplot(aes(x=RecombinationRate,y=NonsynSynRatio))+
  geom_point(alpha=0.3,size=3)+
  scale_x_continuous(trans='log10') +
  stat_smooth(method = "lm", formula = y ~ x, se = FALSE)+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.05,0.05) ,label.y.npc =c(0.15,0.45),size= 3
  )+
  # stat_cor(aes(group=VariantType),label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.25,0.65),size= 3 ) + ##绝对位置 label.x = 100, label.y = 0.0075
  stat_regline_equation(label.x.npc = c(0.05,0.05),label.y.npc = c(0.2,0.5),size= 3)+
  xlab("Recombination rate") + ylab("Ratio of nonsyn SNPs/syn SNPs")+
  scale_y_continuous(limits = c(0,2))+
  # scale_x_continuous(limits = c(0,10))+
  facet_wrap(~Sub,scales = "free_y")+
  theme_classic()+
  theme(strip.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.4, colour = "black")
      # ,legend.key = element_blank(),legend.spacing.y = unit(0, "mm")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 10)

```

### 3.del per cds
```{r}

## 10M window 1M step 
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.delim(dataFile)
nrow(df) ##14075
### 去除Nonsyn/SynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate)) ##13807
head(df)
df <- gather(df,key = "VariantType",value = "CountPerSite", c(DelCountPerSite,SynCountPerSite))
levels(as.factor(df$VariantType))
df <- mutate(df, Sub = substring(df$CHROM,2,2))
colB <- c("#d5311c","#004680")
p <- df %>% 
  sample_frac(0.1) %>% 
  ggplot(aes(x=RecombinationRate,y=CountPerSite,color=VariantType))+
  geom_point(alpha=0.3,size=2)+
  scale_x_continuous(trans='log10') +
  stat_smooth(method = "lm", formula = y ~ x, se = FALSE)+
  stat_cor(
    aes(group=VariantType,label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.05,0.05) ,label.y.npc =c(0.65,0.95),size= 3
  )+
  # stat_cor(aes(group=VariantType),label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.25,0.65),size= 3 ) + ##绝对位置 label.x = 100, label.y = 0.0075
  stat_regline_equation(aes(group=VariantType),label.x.npc = c(0.05,0.05),label.y.npc = c(0.7,1),size= 3)+
  scale_color_manual(values = colB,name="",breaks=c("DelCountPerSite","SynCountPerSite"),labels = c("Deleterious mutations","Synonymous mutations"))+
  xlab("Recombination rate") + ylab("Frequency of mutation\n(SNP count per CDS length)")+
  scale_y_continuous(limits = c(0,0.012))+
  facet_wrap(~Sub,scales = "free_y")+
  theme_classic()+
  theme(strip.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.4, colour = "black")
      # ,legend.key = element_blank(),legend.spacing.y = unit(0, "mm")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
  
p
  
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 10)

```
### 4.del/syn by sub
```{r}
## 10M window 1M step 
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.delim(dataFile)
nrow(df) ##14075
str(df)

### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate)) ##13807
df <- subset(df,!is.na(df$DelSynRatio)) ##13807
df <- mutate(df, Sub = substring(df$CHROM,2,2))
p <- df %>% 
    sample_frac(0.1) %>% 
  ggplot(aes(x=RecombinationRate,y=DelSynRatio))+
  geom_point(alpha=0.3,size=3)+
  scale_x_continuous(trans='log10') +
  stat_smooth(method = "lm", formula = y ~ x, se = FALSE)+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.05,0.05) ,label.y =c(0.7),size= 3
  )+
  # stat_cor(aes(group=VariantType),label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.25,0.65),size= 3 ) + ##绝对位置 label.x = 100, label.y = 0.0075
  stat_regline_equation(label.x.npc = c(0.05,0.05),label.y = c(0.75),size= 3)+
  xlab("Recombination rate") + ylab("Ratio of del SNPs/syn SNPs")+
  # scale_y_continuous(limits = c(0,1.5))+
  coord_cartesian(ylim=c(0,1))+
  # scale_x_continuous(limits = c(0,10))+
  facet_wrap(~Sub,scales = "free_y")+
  theme_classic()+
  theme(strip.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.4, colour = "black")
      # ,legend.key = element_blank(),legend.spacing.y = unit(0, "mm")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
p

ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 10)

```

### 4. del/syn all sub
```{r}
## 10M window 1M step 
dataFile <- c("data/fig2/genomeScan_del_recombination/002_del_nonsyn_synOnChr_10000000Window1000000step.txt")
df <- read.delim(dataFile)
nrow(df) ##14075
str(df)

### 去除DelSynRatio为NA的行
df <- subset(df,!is.na(df$RecombinationRate)) ##13807
df <- subset(df,!is.na(df$DelSynRatio)) ##13807
df <- mutate(df, Sub = substring(df$CHROM,2,2))
p <- df %>% 
    sample_frac(0.1) %>% 
  ggplot(aes(x=RecombinationRate,y=DelSynRatio))+
  geom_point(alpha=0.3,size=3,color="Indianred")+
  scale_x_continuous(trans='log10') +
  stat_smooth(method = "lm", formula = y ~ x, se = FALSE)+
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), 
    label.x.npc = c(0.05,0.05) ,label.y =c(0.7),size= 3
  )+
  # stat_cor(aes(group=VariantType),label.x.npc = c(0.15,0.15) ,label.y.npc =c(0.25,0.65),size= 3 ) + ##绝对位置 label.x = 100, label.y = 0.0075
  stat_regline_equation(label.x.npc = c(0.05,0.05),label.y = c(0.75),size= 3)+
  xlab("Recombination rate") + ylab("Ratio of del SNPs/syn SNPs")+
  # scale_y_continuous(limits = c(0,1.5))+
  coord_cartesian(ylim=c(0,1))+
  # scale_x_continuous(limits = c(0,10))+
  # facet_wrap(~Sub,scales = "free_y")+
  theme_classic()+
  theme(strip.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
      ,panel.background = element_blank()
      ,axis.line = element_line(size=0.4, colour = "black")
      # ,legend.key = element_blank(),legend.spacing.y = unit(0, "mm")
      ,legend.position = 'none'
      ,text = element_text(size = 12))
p

ggsave(p,filename = "~/Documents/test.png",height = 3,width = 4)
```

## ===============
## Sample size to variants count
```{r}

df <- read.delim("data/fig2/009_sampleSize2VariantsDiscovery/003_allSample/ABsub.txt")

factor1 <- c("Synonymous","Nonsynonymous","Deleterious")
df <- df %>% filter(Group != "NA") %>%
  filter(Group %in% factor1) %>%
  droplevels()

dftest <- df %>% 
  filter(TaxaNum != 1)

dftest2 <- df %>% 
  filter(TaxaNum != 607)

dftest$Increasement <- dftest$ObservedCount - dftest2$ObservedCount

dftotalnum <- df %>% filter(TaxaNum == 607,Loop==1) %>% select(Group, ObservedCount)

dftestaa <- dftest %>%left_join(dftotalnum,by="Group") %>% 
  mutate(percent = Increasement/ObservedCount.y)



# write.table(dftest,file="~/Documents/dftest.txt",quote=F,col.name=T,row.names=F,sep = "\t")
# write.table(dftest2,file="~/Documents/dftest2.txt",quote=F,col.name=T,row.names=F,sep = "\t")


# ### 找到每种分类下
# aoFindMaxLine <- function(dfinput){
#   maxtaxanum = max(dfinput$TaxaNum)
#   dfout <- dfinput %>% filter(TaxaNum==maxtaxanum)
#   return(dfout)
# }
# 
# ### 发现每个分类的最大值
# dfpoint <- df %>% group_by(Group) %>% 
#   group_modify(~{.x %>% aoFindMaxLine()})  
# dfpoint$Group <- factor(dfpoint$Group, levels = c("UTR","Syn","Nonsyn"),labels = c("UTR","Synonymous (S)","Nonsynonymous (NS)"))

df$Group <- factor(df$Group, levels = c("Synonymous","Nonsynonymous","Deleterious"))
colB <- c("#004680","#e69f00","#d5311c")
p <- dftestaa %>% 
  filter(TaxaNum < 601) %>% 
  ggplot(aes(x=TaxaNum,y=percent))+
  # stat_smooth(method = "lm", formula = y~poly(x,3),se=F,geom = "smooth")+
  # stat_smooth(se=F)+
  # geom_line()+
  # geom_point()+
  stat_summary(geom = "errorbar"
               # ,width = 8
               ,width = 0.1
               ,fun.min = min
               ,fun.max = max
               ,aes(color = Group)
               # ,alpha = 0.5
               )+
  stat_summary(fun = "mean"
               ,geom = "point"
               ,aes(color = Group)
               # ,alpha = 0.5
               )+ 
   stat_summary(fun = "mean"
               ,geom = "line"
               ,aes(color = Group)
               # ,alpha = 0.9
               )+
  
  # geom_point(data = dfpoint,aes(x=TaxaNum,y=ObservedCount/1000,color=Group),size=2)+
  # scale_x_continuous(breaks = c(1,100,200,300,400,500,600))+
  # geom_line()+
  # stat_function(fun = lm(ObservedCount/1000 ~ poly(TaxaNum, 2, raw = TRUE), data = df,geom="point"))+
  labs(x="Sample size",y="Number of sites observed\nto be variable per kb")+
  scale_color_manual(values = colB)+
  # scale_x_log10(limits = c(10,1000))+
  scale_x_log10()+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(size=0.4, colour = "black"),
      text = element_text(size = 12),)

p
ggsave(p,filename = "~/Documents/test.pdf",height = 3,width = 4)

# ggsave(p,filename = "~/Documents/test.pdf",height = 2.57,width = 3.43)

```












 



